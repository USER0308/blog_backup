/*
 * @Author: USER0308 
 * @Date: 2018-04-11 21:29:52 
 * @Last Modified by: USER0308
 * @Last Modified time: 2018-04-13 11:59:04
 */
技术实现
场景描述:A公司和B公司结成联盟,约定好公司间共享的数据,加入到我们的”依链通”系统中来使用数据共享服务.用户U使用A公司的账户授权登录到B公司,使用B公司的服务.

用户访问授权登录页面时,使用的是传统的B/S架构,即浏览器/服务器架构,用户在浏览器中提交访问请求,服务器作出相应的回答,系统绝大部分数据存储在服务器中,避免了用户需要另外安装客户端的麻烦,同时又不占用用户的磁盘空间.这里的服务器指的是传统的Web服务器,如Apache或者Nginx,用于解析用户发起的请求.
[插图1]
Web服务器接收到用户发起的授权登录请求后,向区块链服务器发起一个”区块链中是否存在该用户的信息”的查询请求,区块链服务器是一个中间件,主要作用是将用户与区块链之间对接起来,为用户提供基于RESTful API的区块链服务.对用户来说,区块链服务器隐藏了区块链层的细节,使得偌大的区块链宛如普通的数据库,为用户提供增删改查的基本操作.
[插图2]
Web服务器向区块链服务器发起查询请求之后,区块链服务器就会在区块链的数据库中查询是否存在该用户的信息,如果用户是首次授权登录,那么区块链数据库中显然没有他的相关信息.这时区块链服务器会向用户账户所在的公司/企业(即A公司)的Web服务器发起一个授权请求,请求参数包含了用户U在A公司的帐号密码等信息,A公司Web服务器检查请求,验证帐号密码等信息,验证通过后可以授权给B公司,根据两家公司约定好共享的数据类型,A公司将用户U在A公司的某些个人信息按照共享数据为模板发送给区块链服务器,区块链服务器接收到这些A,B公司约定共享的数据后,将其保存在区块链中,并以用户U在A公司的帐号作为标识,将其个人信息经过加密后保存在区块链数据库中.
[插图3]
区块链服务器获得了用户U的共享信息后,将其转发给B公司的Web服务器,Web服务器后端再将这些信息写入后Web服务器对应的Web数据库中,用户U信息完成了同步,B公司的Web服务器返回一个授权登录成功的页面,于是用户U就可以使用B公司的服务了.
[插图4]
假设C公司和A,B公司组成联盟,用户U想使用A公司的账户登录C公司,使用其提供的服务,用户U访问授权登录页面,发起授权请求,此时区块链服务器在区块链数据库中查询用户U在A公司的信息,发现区块链数据库中已经存在了,就不必再次向A公司的Web服务器发起授权请求,直接将区块链中用户U的共享信息转发给C公司Web服务器,完成授权.
[插图5]
需要指出的是,区块链服务器虽然在上文中反复出现,但它并非只有一个,有可能是多个服务器提供相同的功能,如果只有一个区块链服务器有违去中心化的思想,而且也容易造成单点失效问题,在Web服务器中维护着所有(或大多数)区块链服务器的域名或ip地址,发起请求时会随机从中挑选一个区块链服务器作为本次会话的建立者.
[插图6]
由于区块链是基于P2P网络,用户U的个人信息很快就会被同步到P2P网络中的各个节点,所以不管是哪个区块链服务器,都能在自己的区块链数据库中查询到加密后的用户U的个人信息.
[插图7]
当用户U第二次使用A公司的账户登录B公司的时候,B公司的Web服务器向区块链服务器发起一个查询请求,区块链服务器查询到用户U的共享信息已经在区块链上了,直接给B公司的Web服务器返回一个token,B公司的Web服务器根据此token在Web数据库中访问用户U的共享信息.
[插图8]
当用户U使用A公司的账户登录联盟内其他公司/企业的账户的时候,他是可以看到他所共享的信息的,比如说联盟内约定好共享的数据有姓名,联系方式,用户U在A公司填写了姓名和联系方式之后,他再使用A公司的账户登录B公司的账户,那么此时显示的姓名和联系方式是与A公司的一样的,也就是说,联盟内所有公司/企业共享这些约定好的共享数据.
[插图9]
用户U使用A公司的账户登录联盟内的B公司,在B公司提供的修改信息服务中修改了共享信息,将联系方式改了,此时B公司的Web服务器就会将此次修改的键值对附加到报文中发送给区块链服务器,区块链服务器接收到修改请求后,修改区块链数据库中的信息,等到P2P网络完成同步.下次用户U使用A公司的帐户登录联盟内的C公司,C公司的Web服务器向区块链服务器发起一个查询请求,区块链服务器查询到用户U的共享信息更新了,于是把最新的共享信息发给C公司的Web服务器,Web服务器更新自己的数据库,继续为用户U提供服务,所以此时用户U可以看到自己的联系方式已经同步修改了.
[插图10]
A公司,B公司和C公司等公司组成一个联盟,假设他们提供的是人才招聘服务,他们之间会共享一些数据比如姓名,年龄,性别,毕业大学,学历等.X公司,Y公司,Z公司等公司组成另外一个联盟,假设他们提供的是相亲婚恋介绍服务,他们之间也会共享一些数据比如姓名,年龄,性别,学历,年/月薪,对伴侣的期望等.我们可以看到这两个不同行业的联盟之间也存在着数据共享的可能性.假设这两个联盟之间也达成合作关系,当然这种联盟间合作关系肯定不像联盟内合作关系那么紧密,表现在共享数据上就是共享的数据变少了,联盟间共享的数据可以只是姓名,年龄,性别,学历等,于是这两个联盟也组成一个联盟,在各自的联盟内共享行业联系紧密的数据,在联盟间共享行业联系不那么紧密的数据,再将此模式推展开来,在各个行业内都可形成联盟,跨行业间也可形成联盟.
[插图11]
上文所述的联盟,其实是应用了区块链中的联盟链,众所周知,区块链经历了三个阶段,第一次是以2008年中本聪提出的比特币为代表的加密数字货币,称为区块链1.0,第二次是以以太坊为代表的图灵完备的智能合约,称为区块链2.0,第三次则是以Hyperledger Fabric为代表的为全领域提供去中心化,支持权限管理的解决方案,称为区块链3.0,联盟链正是区块链3.0的产物,相比于区块链1.0和2.0,区块链3.0创新性地引入了权限管理机制,这与公司企业等组织天然地契合,基于权限的访问控制确保了数据的安全性,用户U无需担心自己在联盟内的共享数据被权限外的人看到,同时,Hyperledger Fabric创新性地实现了多通道的技术,一个联盟组成一个通道,联盟内的公司企业组织成员加入同一个通道中,组成联盟,如上所述,A,B,C公司属于一个联盟,X,Y,Z公司属于另外一个联盟,A,B,C,X,Y,Z又组成新的一个联盟.需要特别指出的是,每个联盟(通道)都有各自的区块链数据库,不同联盟不同通道之间的数据是不流通的,数据只能由某个联盟内部产生,被联盟内部消化,ABC组成的联盟中的区块链上的数据对于XYZ联盟的成员来说是不可见的,但是在ABCXYZ组成的联盟中,区块链上的数据对这几家公司企业组织都是公开透明的.在ABC联盟中流通的数据是人才招聘数据如姓名,年龄,性别,毕业大学,学历等,在XYZ联盟中流通的数据是相亲婚恋数据如姓名,年龄,性别,学历,年/月薪,对伴侣的期望等,而在ABCXYZ联盟中流通的数据则是姓名,年龄,性别,学历等.同时注意到数据在通道间的不可流通性,所以ABC公司和XYZ公司除了上传用户信息到各自的联盟中外,还要上传到ABCXYZ的共同联盟中.
[插图12]
现在让我们看看一个联盟内的详细结构,以ABC联盟为例.
[插图13]
联盟由多个组织组成,一个公司就是一个组织,组织可以设置多个节点,节点是区块链的通信主体,是一个逻辑概念,多个不同类型的节点可以运行在同一个物理服务器上.节点类型有客户端,Peer节点,排序服务节点和CA节点.
客户端节点:
客户端或者应用程序代表由最终客户操作的实体,它必须连接到某一个Peer节点或者排序服务节点上与区块链网络进行通信.客户端向背书节点提交提案,当收集到足够背书后,向排序服务广播交易,进行排序,生成区块.
Peer节点:
所有的Peer节点都是记账节点,负责验证从排序服务节点区块里的交易,维护状态数据和账本的副本.部分节点会执行交易并对结果进行签名背书,充当背书节点的角色.背书节点是动态的角色,是与具体链码绑定的.每个链码在实例化的时候都会设置背书策略,指定哪些节点对交易背书后才是有效的.也只有在应用程序向它发起交易背书请求的时候才是背书节点,其他的时候就是普通的记账节点,只负责验证交易并记账.Peer节点还有一种角色是主节点,代表的是和排序服务节点通信的节点,负责从排序服务节点处获取最新的区块并在组织内部同步.
排序服务节点:
排序服务节点接收包含背书签名的交易,对未打包的交易进行排序生成区块,广播给Peer节点.排序服务提供的是原子广播,保证同一个链上的节点接收到相同的消息,并且有相同的逻辑顺序.
CA节点:
CA节点是Hyperledger Fabric 1.0的证书颁发机构,由服务器和客户端组件组成.CA节点接受客户端的申请注册,返回注册密码用于用户登录,以便获取其身份证书.在区块链网络上所有的操作都会验证用户的身份.
在我们的例子中,区块链服务器就相当于客户端节点,负责与Peer节点通信,进而与区块链交互.当用户U修改更新数据时,表现在区块链网络中就是发起一笔提案,发送到各个背书节点,背书节点验证后添加上自己的签名,区块链服务器收集到足够多的背书后就会把提案(此时称为交易)广播给排序服务节点,排序服务节点对此交易以及这段时间内其他用户发起的交易进行打包排序,生成区块,再广播给主节点,经由主节点广播给组织内部节点,各节点收到广播后把新区块保存到各自维护的已有的区块的尾部,形成一本链式账本,由于每个区块都是由排序服务节点排序后依次广播的,所以整个区块链网络的账本都是一致的.

现在进入Peer节点的内部,可以看到Peer节点主要功能是维护数据,包括三个数据集合,一个是State DB,一个是History DB,还有一个是Index DB.State DB一般使用Couch DB作为数据库,将数字资产建模为更高级的json格式,提供更高层的查询,Index DB使用Level DB作为数据库,提供方便的键值对查询,而History DB则是使用文件系统来存储大量的历史区块数据.每次交易使得系统数据发生变化时,State DB记录变化之后的系统当前数据状态,而将交易打包成块写入History DB永久存储,还会建立索引指向此交易区块.


至此,大体的技术实现轮廓已经勾勒出来了
